<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <TITLE> New Document </TITLE>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/style.css">
    <script src="js/jquery-1.12.3.js"></script>
    <script src="js/common.js"></script>

    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">

    <style>
        .map_wrap, .map_wrap * {
            margin: 0;
            padding: 0;
            font-family: 'Malgun Gothic', dotum, '돋움', sans-serif;
            font-size: 12px;
        }

        .map_wrap a, .map_wrap a:hover, .map_wrap a:active {
            color: #000;
            text-decoration: none;
        }

        .map_wrap {
            position: relative;
            width: 100%;
            height: 500px;
        }

        #menu_wrap {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 250px;
            margin: 10px 0 30px 10px;
            padding: 5px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.7);
            z-index: 1;
            font-size: 12px;
            border-radius: 10px;
        }

        .bg_white {
            background: #fff;
        }

        #menu_wrap hr {
            display: block;
            height: 1px;
            border: 0;
            border-top: 2px solid #5F5F5F;
            margin: 3px 0;
        }

        #menu_wrap .option {
            text-align: center;
        }

        #menu_wrap .option p {
            margin: 10px 0;
        }

        #menu_wrap .option button {
            margin-left: 5px;
        }

        #placesList li {
            list-style: none;
        }

        #placesList .item {
            position: relative;
            border-bottom: 1px solid #888;
            overflow: hidden;
            cursor: pointer;
            min-height: 65px;
        }

        #placesList .item span {
            display: block;
            margin-top: 4px;
        }

        #placesList .item h5, #placesList .item .info {
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        #placesList .item .info {
            padding: 10px 0 10px 55px;
        }

        #placesList .info .gray {
            color: #8a8a8a;
        }

        #placesList .info .jibun {
            padding-left: 26px;
            background: url(https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/places_jibun.png) no-repeat;
        }

        #placesList .info .tel {
            color: #009900;
        }

        #placesList .item .defaultMarker {
            background: url(http://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png) no-repeat;
        }

        #placesList .item .markerbg {
            float: left;
            position: absolute;
            width: 36px;
            height: 37px;
            margin: 10px 0 0 10px;
            background: url(http://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png) no-repeat;
        }

        .blueMarker {
            float: left;
            position: absolute;
            width: 36px;
            height: 37px;
            background-image: url(http://t1.daumcdn.net/localimg/localimages/07/2018/pc/img/marker_spot.png);
            background-size: 36px 37px;
            background-repeat: no-repeat;
        }

        .SearchTitle {
            padding: 10px 0 10px 55px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        #pagination {
            margin: 10px auto;
            text-align: center;
        }

        #pagination a {
            display: inline-block;
            margin-right: 10px;
        }

        #pagination .on {
            font-weight: bold;
            cursor: default;
            color: #777;
        }
    </style>
</head>
<body>
<div id="fullpage">
    <th:block th:replace="/header"></th:block>

    <div class="area-dept01"></div>

    <div class="map_wrap">

        <div id="map" style="width:100%;height:800px;"></div>

        <div id="menu_wrap" class="bg_white">
            <div class="option">
                <div>
                    <form onsubmit="searchPlaces(); return false;">
                        키워드 : <input type="text" value="" id="keyword" size="15">
                        <button type="submit">검색하기</button>
                    </form>
                </div>
            </div>
            <hr>
            <ul id="placesList"></ul>
            <div id="pagination"></div>
        </div>
    </div>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6fc3dce29981b178f7dabe1dda337ac3&libraries=services"></script>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=6fc3dce29981b178f7dabe1dda337ac3"></script>

    <script th:inline="javascript">

        var mapContainer = document.getElementById('map'), // 지도를 표시할 div
            mapOption = {
                center: new kakao.maps.LatLng(36.4886850973867, 127.74243728374), // 지도의 중심좌표
                level: 12 // 지도의 확대 레벨
            };

        var map = new kakao.maps.Map(mapContainer, mapOption); // 지도를 생성합니다

        var places = new kakao.maps.services.Places();

        var markers = [];

        // 마커 이미지의 이미지 주소입니다
        var imageSrc = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";

        var imageSize = new kakao.maps.Size(24, 35);
        // 마커 이미지를 생성합니다
        var markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize);

        // 검색 결과 목록이나 마커를 클릭했을 때 장소명을 표출할 인포윈도우를 생성합니다
        var infowindow = new kakao.maps.InfoWindow({zIndex: 1});

        var storeList = [];

        //처음 페이지 입장시 DB에 존재하는 모든 가게정보를 불러옴
        searchPlaces();

        function searchPlaces() {
            //keyword를 가져오기
            var keyword = document.getElementById('keyword').value;

            displayStores(keyword);
        }

        function displayStores(keyword) {

            var listEl = document.getElementById('placesList'),
                //menuEl = document.getElementById('menu_wrap'),
                fragment = document.createDocumentFragment(),
                listStr = '';

            // 검색 결과 목록에 추가된 항목들을 제거합니다
            removeAllChildNods(listEl);

            // 지도에 표시되고 있는 마커를 제거합니다
            removeMarker();

            displayMarkers(fragment, keyword);

            listEl.appendChild(fragment);
            //menuEl.scrollTop = 0;

            // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
            //map.setBounds(bounds);
        }

        function displayMarkers(fragment, keyword) {

            //console.log(keyword.length);

            var bounds = new kakao.maps.LatLngBounds();

            if (keyword) {
                var stores = new Array();

                stores = [[${stores}]];

                console.log(stores.length);

                for (var i = 0; i < stores.length; i++) {
                    var store = stores[i];

                    var name = store['name'];

                    //keyword에서 일치하는 항목이 있으면 배열에 저장
                    var result = name.indexOf(keyword);

                    if (result > -1) {
                        var placePosition = new kakao.maps.LatLng(store['latitude'], store['longitude']),
                            marker = addMarker(placePosition),
                            itemEl = getListItem(store['id'], store['name'], store['address'], store['phoneNum'], store['latitude'], store['longitude']);

                        console.log("검색결과 가게이름 : " + name + " keyword 값 : " + keyword + " result 값 : " + result);

                        bounds.extend(placePosition);

                        (function (marker, title, latitude, longitude) {
                            kakao.maps.event.addListener(marker, 'mouseover', function () {
                                displayInfowindow(marker, title);
                            });

                            /*kakao.maps.event.addListener(marker, 'mouseout', function() {
                                infowindow.close();
                            });*/

                            //마커 클릭 이벤트, 마커의 위도 경도 나타냄
                            kakao.maps.event.addListener(marker, 'click', function () {
                                //displayInfowindow_coord(marker);

                                var ticket = [[${ticket}]];

                                function checkTicket() {
                                    if (ticket.getId() == null) {
                                        return '<button type="submit" class="btn btn-dark"> 번호표 뽑기</button> </form> </div>'
                                    }
                                }
                                //html로 표시될 인포 윈도우의 내용
                                infowindow.setContent('<div align="center" style="padding:5px;font-size:15px;">' + store['name'] + "<br>" + '</div>' +
                                    '<div style="padding:5px;font-size:12px;">' + store['address'] + "<br>" + '</div>' +
                                    '<div style="padding:5px;font-size:12px;">' + store['phoneNum'] + "<br>" + '</div>' +
                                    '<div> <form onsubmit="; return false;"> ' +
                                    '' +
                                    checkTicket());

                                //infowindow.setContent('<div style="padding:5px;font-size:12px;">' + "위도 : " + {{longitude}} + "<br>" + "경도 : " + {{latitude}} + '</div>')
                            });

                            itemEl.onmouseover = function () {
                                displayInfowindow(marker, title);
                            };

                            itemEl.onmouseout = function () {
                                infowindow.close();
                            };

                            if (fragment)
                                fragment.appendChild(itemEl);

                        })(marker, store['name'], store['latitude'], store['longitude']);

                        // 검색된 장소 위치를 기준으로 지도 범위를 재설정합니다
                        // 불러온 가게 DB의 개수가 0개 일때 재설정 하면 카카오맵이 사라짐
                        map.setBounds(bounds);
                    }
                }
            } else {
                var stores = new Array();

                stores = [[${stores}]];

                console.log(stores.length);

                for (var i = 0; i < stores.length; i++) {
                    var store = stores[i];

                    console.log(store);

                    var placePosition = new kakao.maps.LatLng(store['latitude'], store['longitude']),
                        marker = addMarker(placePosition),
                        itemEl = getListItem(store['id'], store['name'], store['address'], store['phoneNum'], store['latitude'], store['longitude']);

                    bounds.extend(placePosition);

                    (function (marker, title, latitude, longitude) {
                        kakao.maps.event.addListener(marker, 'mouseover', function () {
                            displayInfowindow(marker, title);
                        });

                        /*kakao.maps.event.addListener(marker, 'mouseout', function() {
                            infowindow.close();
                        });*/

                        //마커 클릭 이벤트, 마커의 위도 경도 나타냄
                        kakao.maps.event.addListener(marker, 'click', function () {
                            //displayInfowindow_coord(marker);

                            //html로 표시될 인포 윈도우의 내용
                            infowindow.setContent('<div align="center" style="padding:5px;font-size:15px;">' + store['name'] + "<br>" + '</div>' +
                                '<div style="padding:5px;font-size:12px;">' + store['address'] + "<br>" + '</div>' +
                                '<div style="padding:5px;font-size:12px;">' + store['phoneNum'] + "<br>" + '</div>' +
                                '<div> <form onsubmit="; return false;"> <button type="submit" class="btn btn-dark"> 번호표 뽑기</button> </form> </div>');

                            //infowindow.setContent('<div style="padding:5px;font-size:12px;">' + "위도 : " + {{longitude}} + "<br>" + "경도 : " + {{latitude}} + '</div>')
                        });

                        itemEl.onmouseover = function () {
                            displayInfowindow(marker, title);
                        };

                        itemEl.onmouseout = function () {
                            infowindow.close();
                        };

                        if (fragment)
                            fragment.appendChild(itemEl);

                    })(marker, store['name'], store['latitude'], store['longitude']);
                }
            }
        }

        function displayInfowindow(marker, title) {
            var content = '<div style="padding:5px;z-index:1;">' + title + '</div>';

            infowindow.setContent(content);
            infowindow.open(map, marker);
        }

        function addMarker(position) {
            marker = new kakao.maps.Marker({
                position: position, // 마커의 위치
            });

            marker.setMap(map); // 지도 위에 마커를 표출합니다
            markers.push(marker);  // 배열에 생성된 마커를 추가합니다

            return marker;
        }

        // 지도 위에 표시되고 있는 마커를 모두 제거합니다
        function removeMarker() {
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
            markers = [];
        }

        function getListItem(index, name, address, phonenumber, latitude, longitude) {
            var el = document.createElement('li'),
                itemStr = '<span class="blueMarker"> </span>' +
                    '<div class="info">' +
                    '   <h5>' + name + '</h5>';

            itemStr += '    <span>' + address + '</span>';

            itemStr += '  <span style="color:#009900;">' + phonenumber + '</span>' +
                '</div>';

            itemStr += '  <form onsubmit=" /*번호표페이지로 이동 함수*/ ; return false;">' +
                '<button type="submit" class="btn btn-dark">' + "번호표뽑기" + '</button>' + '</form>';
            /*itemStr += '  <span class="tel">' + "위도 : " + longitude + " <br> " + "경도 : " + latitude +'</span>' +
                    '</div>';*/

            el.innerHTML = itemStr;
            el.className = 'item';

            return el;
        }

        function removeAllChildNods(el) {
            while (el.hasChildNodes()) {
                el.removeChild(el.lastChild);
            }


        }
    </script>
</div>

</body>
</html>